<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat App</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    :root[data-theme="dark"] { --bg: #121212; --text: #fff; --bubble: #333; }
    :root[data-theme="light"] { --bg: #f5f5f5; --text: #000; --bubble: #fff; }
    :root[data-theme="blue"] { --bg: #eaf3ff; --text: #000; --bubble: #cce0ff; }

    #app { display: flex; height: 100vh; }
    #sidebar {
      width: 250px; background: #222; color: #fff; padding: 10px;
      display: flex; flex-direction: column;
    }
    #sidebar h2 { margin-top: 0; }
    #chatList { flex: 1; overflow-y: auto; margin-top: 10px; }
    .chat-item { padding: 10px; cursor: pointer; border-radius: 5px; margin: 5px 0; background: #333; }
    .chat-item:hover { background: #444; }

    #main {
      flex: 1; display: flex; flex-direction: column;
    }
    #messages {
      flex: 1; overflow-y: auto; padding: 10px;
    }
    .msg {
      padding: 8px 12px; margin: 5px; border-radius: 12px;
      max-width: 60%; clear: both;
    }
    .mine { background: var(--bubble); float: right; }
    .theirs { background: #888; float: left; color: #fff; }

    #inputBar {
      display: flex; border-top: 1px solid #ccc; padding: 10px;
    }
    #inputBar input { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #ccc; }
    #inputBar button { margin-left: 8px; padding: 8px 12px; border: none; border-radius: 8px; background: #0066ff; color: #fff; cursor: pointer; }

    #settingsModal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center;
    }
    #settingsBox {
      background: #fff; color: #000; padding: 20px; border-radius: 10px; width: 300px;
    }
    #settingsBox h3 { margin-top: 0; }
    #closeSettings { float: right; cursor: pointer; color: red; }

    #newChatBtn {
      padding: 10px; margin: 10px 0; background: #28a745; color: #fff; border: none;
      border-radius: 5px; cursor: pointer; width: 100%;
    }
  </style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <h2>Chats</h2>
    <button id="newChatBtn">+ New Private Chat</button>
    <div id="chatList"></div>
    <button onclick="logout()">Logout</button>
    <button onclick="openSettings()">‚öô Settings</button>
  </div>
  <div id="main">
    <div id="messages"></div>
    <div id="inputBar">
      <input id="messageInput" placeholder="Type a message..." />
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>
</div>

<div id="settingsModal">
  <div id="settingsBox">
    <span id="closeSettings">X</span>
    <h3>Settings</h3>
    <label>Theme:
      <select id="themeSelect">
        <option value="dark">Dark</option>
        <option value="light">Light</option>
        <option value="blue">Blue</option>
      </select>
    </label>
  </div>
</div>

<script>
  // Firebase setup
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentUser = null;
  let currentRoom = "global";

  auth.onAuthStateChanged(user => {
    if (user) {
      // Always update localStorage username
      db.collection("users").doc(user.uid).get().then(doc => {
        currentUser = doc.exists ? doc.data().username : user.email;
        localStorage.setItem("username", currentUser);
        loadChats();
        loadMessages("global");
      });
    } else {
      window.location.href = "login.html";
    }
  });

  // Load chat list
  function loadChats() {
    const list = document.getElementById("chatList");
    list.innerHTML = `<div class="chat-item" onclick="switchRoom('global')">üåç Global Chat</div>`;
    db.collection("privateChats").where("members", "array-contains", currentUser)
      .onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
          if (change.type === "added") {
            const roomId = change.doc.id;
            const chatItem = document.createElement("div");
            chatItem.className = "chat-item";
            chatItem.innerText = "üîí " + roomId.replaceAll("_", " & ");
            chatItem.onclick = () => switchRoom(roomId, true);
            list.appendChild(chatItem);
          }
        });
      });
  }

  // Switch room
  function switchRoom(roomId, isPrivate=false) {
    currentRoom = roomId;
    document.getElementById("messages").innerHTML = "";
    loadMessages(roomId, isPrivate);
  }

  // Load messages
  function loadMessages(roomId, isPrivate=false) {
    let ref = isPrivate ? db.collection("privateChats").doc(roomId).collection("messages") :
                          db.collection("global");
    ref.orderBy("timestamp").onSnapshot(snapshot => {
      const messages = document.getElementById("messages");
      messages.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const msg = document.createElement("div");
        msg.className = "msg " + (data.sender === currentUser ? "mine" : "theirs");
        msg.innerText = `${data.sender}: ${data.text}`;
        messages.appendChild(msg);
      });
      messages.scrollTop = messages.scrollHeight;
    });
  }

  // Send message
  function sendMessage() {
    const text = document.getElementById("messageInput").value;
    if (!text) return;
    const msg = {
      sender: currentUser,
      text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };
    if (currentRoom === "global") {
      db.collection("global").add(msg);
    } else {
      db.collection("privateChats").doc(currentRoom).collection("messages").add(msg);
    }
    document.getElementById("messageInput").value = "";
  }

  // New private chat
  document.getElementById("newChatBtn").onclick = () => {
    const other = prompt("Enter username of user to chat with:");
    if (!other || other === currentUser) return;
    const roomId = [currentUser, other].sort().join("_");
    db.collection("privateChats").doc(roomId).set({
      members: [currentUser, other]
    }, { merge: true });
    switchRoom(roomId, true);
  };

  // Delete private chat
  function deletePrivateChat(roomId) {
    if (confirm("Delete this private chat?")) {
      db.collection("privateChats").doc(roomId).delete();
      switchRoom("global");
    }
  }

  // Settings
  function openSettings() {
    document.getElementById("settingsModal").style.display = "flex";
  }
  document.getElementById("closeSettings").onclick = () => {
    document.getElementById("settingsModal").style.display = "none";
  };
  const themeSelect = document.getElementById("themeSelect");
  themeSelect.onchange = () => {
    document.documentElement.dataset.theme = themeSelect.value;
    localStorage.setItem("theme", themeSelect.value);
  };
  const savedTheme = localStorage.getItem("theme");
  if (savedTheme) {
    document.documentElement.dataset.theme = savedTheme;
    themeSelect.value = savedTheme;
  }

  // Logout
  function logout() {
    auth.signOut();
  }
</script>
</body>
</html>
