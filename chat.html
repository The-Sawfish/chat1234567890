<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Hybrid Chat ‚Äî Firebase</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{--bg:#f5f7fa;--sidebar:#2c3e50;--accent:#3498db;--text:#222;--card:#fff;--self:#2ecc71;--other:#bdc3c7}
  [data-theme="dark"]{--bg:#0f1112;--sidebar:#16202b;--accent:#256aa2;--text:#eaeef0;--card:#151718}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,Arial,sans-serif}
  .stage{display:flex;justify-content:center;align-items:center;height:100vh;padding:12px;box-sizing:border-box}
  #app{display:flex;width:95%;max-width:1100px;height:86vh;border-radius:12px;overflow:hidden;box-shadow:0 8px 30px rgba(2,6,23,.12)}
  #sidebar{width:260px;background:var(--sidebar);color:#fff;padding:12px;display:flex;flex-direction:column;box-sizing:border-box}
  #sidebar h3{margin:6px 0 10px;text-align:center}
  .room-btn{padding:8px;border-radius:8px;background:transparent;border:0;color:#fff;margin:6px 0;cursor:pointer;text-align:left}
  .room-btn.active{background:rgba(255,255,255,0.06)}
  #main{flex:1;display:flex;flex-direction:column;background:var(--card)}
  header{padding:12px;background:var(--accent);color:#fff;display:flex;justify-content:space-between;align-items:center}
  #chat{flex:1;overflow:auto;padding:14px;background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent)}
  .msg{max-width:72%;padding:10px;border-radius:10px;margin:8px 0;word-break:break-word}
  .self{background:var(--self);color:#fff;float:right}
  .other{background:var(--other);color:#111;float:left}
  .meta{font-size:11px;color:rgba(0,0,0,0.45);margin-top:6px}
  footer{display:flex;padding:10px;border-top:1px solid rgba(0,0,0,0.06);gap:8px}
  input.message{flex:1;padding:10px;border-radius:10px;border:1px solid #d6dbe0}
  button.send{padding:10px 12px;border-radius:10px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  /* small modals */
  .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5)}
  .panel{background:var(--card);padding:14px;border-radius:10px;min-width:320px}
  .user-list{max-height:220px;overflow:auto;border:1px solid #eee;padding:8px;border-radius:8px}
  .user-item{display:flex;justify-content:space-between;align-items:center;padding:6px;border-bottom:1px solid #f1f1f1}
  .badge{background:#ff4d4f;color:#fff;padding:4px 8px;border-radius:999px;font-size:12px}
</style>
</head>
<body data-theme="light">
<div class="stage">
  <div id="app">
    <aside id="sidebar">
      <h3>Chats</h3>
      <div id="roomsList"></div>

      <h3 style="margin-top:14px">People</h3>
      <div id="usersList" style="margin-bottom:8px"></div>

      <div style="margin-top:auto;display:flex;flex-direction:column;gap:8px">
        <button id="newChatBtn" class="room-btn">‚ûï New Private/Group Chat</button>
        <button id="requestsBtn" class="room-btn">üîî Requests <span id="reqCount" class="badge" style="display:none">0</span></button>
        <button id="settingsBtn" class="room-btn">‚öôÔ∏è Settings</button>
      </div>
    </aside>

    <main id="main">
      <header>
        <div id="title">‚Äî</div>
        <div id="subtitle">‚Äî</div>
      </header>

      <section id="chat"></section>

      <footer>
        <input id="msgInput" class="message" placeholder="Type a message‚Ä¶" disabled>
        <button id="sendBtn" class="send" disabled>Send</button>
      </footer>
    </main>
  </div>
</div>

<!-- New Chat Modal -->
<div id="newChatModal" class="modal">
  <div class="panel">
    <h3>Create a chat (max 6 users)</h3>
    <div style="font-size:13px;color:#666;margin-bottom:8px">Select up to 5 other users to invite:</div>
    <div id="createUsers" class="user-list"></div>
    <input id="groupLabel" placeholder="Optional chat name (group)"/>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="createChatConfirm" class="btn">Create</button>
      <button id="createCancel" class="btn">Cancel</button>
    </div>
    <div id="createMsg" style="color:#c0392b;margin-top:8px;font-size:13px"></div>
  </div>
</div>

<!-- Requests Modal -->
<div id="requestsModal" class="modal">
  <div class="panel">
    <h3>Pending Chat Requests</h3>
    <div id="requestsList" class="user-list"></div>
    <div style="text-align:right;margin-top:10px"><button id="closeReq" class="btn">Close</button></div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">
  <div class="panel">
    <h3>Settings</h3>
    <label>Theme</label>
    <select id="themeSelect" style="width:100%;padding:8px;margin:8px 0">
      <option value="light">Light</option>
      <option value="dark">Dark</option>
      <option value="sunset">Sunset</option>
      <option value="forest">Forest</option>
      <option value="ocean">Ocean</option>
      <option value="midnight">Midnight</option>
    </select>
    <button id="logoutBtn" style="background:#e74c3c;color:#fff;padding:8px;border:0;border-radius:8px;cursor:pointer">Logout</button>
    <div style="text-align:right;margin-top:10px"><button id="closeSettingsBtn" class="btn">Close</button></div>
  </div>
</div>

<script type="module">
/* Firebase imports */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc, query, orderBy, onSnapshot,
  doc, getDoc, setDoc, getDocs, where, updateDoc, serverTimestamp, deleteDoc
} from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

/* config */
const firebaseConfig = {
  apiKey: "AIzaSyA0m8RzkSmIgdPxvyMqW6SKsNLa_EvZJ9w",
  authDomain: "hybridchat-8a96c.firebaseapp.com",
  projectId: "hybridchat-8a96c",
  storageBucket: "hybridchat-8a96c.firebasestorage.app",
  messagingSenderId: "8350065462",
  appId: "1:8350065462:web:779c8fd3c81acaeebc8997"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* UI refs */
const roomsList = document.getElementById('roomsList');
const usersList = document.getElementById('usersList');
const chatEl = document.getElementById('chat');
const titleEl = document.getElementById('title');
const subtitleEl = document.getElementById('subtitle');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');

const newChatBtn = document.getElementById('newChatBtn');
const newChatModal = document.getElementById('newChatModal');
const createUsers = document.getElementById('createUsers');
const createChatConfirm = document.getElementById('createChatConfirm');
const createCancel = document.getElementById('createCancel');
const createMsg = document.getElementById('createMsg');
const groupLabel = document.getElementById('groupLabel');

const requestsBtn = document.getElementById('requestsBtn');
const reqCount = document.getElementById('reqCount');
const requestsModal = document.getElementById('requestsModal');
const requestsList = document.getElementById('requestsList');
const closeReq = document.getElementById('closeReq');

const settingsBtn = document.getElementById('settingsBtn');
const settingsModal = document.getElementById('settingsModal');
const themeSelect = document.getElementById('themeSelect');
const logoutBtn = document.getElementById('logoutBtn');
const closeSettingsBtn = document.getElementById('closeSettingsBtn');

const MAX_PARTICIPANTS = 6;

/* state */
let currentUser = null;
let username = null; // display name
let currentRoom = 'Global';
let roomsMetaUnsub = null;
let messagesUnsub = null;
let myRooms = {}; // rooms the user is a member of

/* AUTH state */
onAuthStateChanged(auth, async (u) => {
  if(!u){ window.location.href = 'login.html'; return; }
  currentUser = u;
  // load username from users/{uid}
  const snap = await getDoc(doc(db,'users', u.uid));
  username = snap.exists() ? snap.data().username : (u.email ? u.email.split('@')[0] : u.uid);
  // UI enable
  msgInput.disabled = false; sendBtn.disabled = false;
  titleEl.innerText = username + ' ‚Ä¢ Global';
  subtitleEl.innerText = 'Public chat';
  // load lists
  await loadUsersList();
  subscribeMyRooms();
  subscribeRequests();
  switchRoom('Global');
  // apply saved theme
  const saved = localStorage.getItem('theme');
  if(saved) document.body.setAttribute('data-theme', saved);
});

/* LOAD users list (for selection and display) */
async function loadUsersList(){
  usersList.innerHTML = '';
  const usersSnap = await getDocs(collection(db,'users'));
  usersSnap.forEach(docSnap=>{
    const u = docSnap.data();
    const btn = document.createElement('button');
    btn.className = 'room-btn';
    btn.textContent = (u.username || u.email);
    if(u.username === username) btn.disabled = true;
    btn.onclick = ()=> {
      // quick start private chat request to single user
      openNewChatModal([u.username]);
    };
    usersList.appendChild(btn);
  });
}

/* Subscribe to roomsMeta where members array contains me (and also include Global) */
function subscribeMyRooms(){
  // unsubscribe previous
  if(roomsMetaUnsub) roomsMetaUnsub();

  // Rooms meta where members array contains currentUser.uid
  const q = query(collection(db,'roomsMeta'), orderBy('lastUpdated','desc'));
  roomsMetaUnsub = onSnapshot(q, snap=>{
    myRooms = {};
    snap.forEach(docSnap=>{
      const data = docSnap.data();
      const roomId = docSnap.id;
      if(Array.isArray(data.members) && data.members.includes(currentUser.uid)){
        myRooms[roomId] = data;
      }
    });
    renderRoomsList();
  });
}

/* Render rooms: Global first, then joined rooms */
function renderRoomsList(){
  roomsList.innerHTML = '';
  // Global
  const g = document.createElement('button'); g.className='room-btn' + (currentRoom==='Global'?' active':''); g.textContent='üåç Global'; g.onclick=()=>switchRoom('Global');
  roomsList.appendChild(g);
  // other rooms
  Object.entries(myRooms).forEach(([id,data])=>{
    const b = document.createElement('button'); b.className='room-btn' + (currentRoom===id?' active':''); b.textContent = data.label || data.members.join(', '); b.onclick=()=>switchRoom(id);
    roomsList.appendChild(b);
  });
}

/* Switch room: sets up message listener */
function switchRoom(roomId){
  currentRoom = roomId;
  renderRoomsList();
  chatEl.innerHTML = '';
  if(messagesUnsub) messagesUnsub();

  if(roomId === 'Global'){
    titleEl.innerText = username + ' ‚Ä¢ Global';
    subtitleEl.innerText = 'Public chat';
  } else {
    const meta = myRooms[roomId] || {};
    titleEl.innerText = username + ' ‚Ä¢ ' + (meta.label || 'Private chat');
    subtitleEl.innerText = 'Private / group';
  }

  const q = query(collection(db,'rooms',roomId,'messages'), orderBy('time'));
  messagesUnsub = onSnapshot(q, snap=>{
    chatEl.innerHTML = '';
    snap.forEach(docSnap=>{
      appendMsgDOM(docSnap.data());
    });
    chatEl.scrollTop = chatEl.scrollHeight;
  });
}

/* Append message DOM (keeps send mechanism) */
function appendMsgDOM(m){
  const d = document.createElement('div');
  d.className = 'msg ' + (m.user === username ? 'self':'other');
  const txt = document.createElement('div'); txt.textContent = m.text;
  const meta = document.createElement('div'); meta.className = 'meta'; meta.textContent = `${m.user} ‚Ä¢ ${new Date(m.time).toLocaleTimeString()}`;
  d.appendChild(txt); d.appendChild(meta); chatEl.appendChild(d);
}

/* Send message (unchanged mechanism) */
async function sendMessage(text){
  if(!currentUser) return alert('Log in first');
  await addDoc(collection(db,'rooms',currentRoom,'messages'),{
    user: username,
    text,
    time: Date.now()
  });
}

/* UI: send */
sendBtn.onclick = ()=>{
  const t = msgInput.value.trim(); if(!t) return;
  sendMessage(t); msgInput.value='';
};
msgInput.addEventListener('keydown', e=>{ if(e.key==='Enter') sendBtn.click(); });

/* NEW CHAT flow: open modal showing selectable users (checkbox up to 5 other users) */
newChatBtn.onclick = async ()=>{
  // build panel users only once
  await buildCreateUsers(); openModal(newChatModal);
};

async function buildCreateUsers(){
  createUsers.innerHTML = '';
  const q = query(collection(db,'users'));
  const snap = await getDocs(q);
  snap.forEach(docSnap=>{
    const u = docSnap.data();
    if(u.username === username) return;
    const item = document.createElement('div'); item.className='user-item';
    const lbl = document.createElement('div'); lbl.textContent = u.username;
    const cb = document.createElement('input'); cb.type='checkbox'; cb.dataset.username = u.username; cb.dataset.uid = docSnap.id;
    item.appendChild(lbl); item.appendChild(cb); createUsers.appendChild(item);
  });
}

/* helper: open/close modal */
function openModal(m){ m.style.display = 'flex'; }
function closeModal(m){ m.style.display = 'none'; }
createCancel.onclick = ()=> closeModal(newChatModal);

/* Confirm create chat request */
createChatConfirm.onclick = async ()=>{
  createMsg.textContent = '';
  const checked = Array.from(createUsers.querySelectorAll('input[type=checkbox]:checked'));
  const selectedUids = checked.map(c=>c.dataset.uid);
  const selectedNames = checked.map(c=>c.dataset.username);
  // include self
  if(selectedUids.length === 0) { createMsg.textContent = 'Pick at least one other user'; return; }
  if(selectedUids.length + 1 > MAX_PARTICIPANTS) { createMsg.textContent = `Max ${MAX_PARTICIPANTS} users total`; return; }

  // build roomId deterministically using UIDs
  const allUids = [currentUser.uid, ...selectedUids].sort();
  const roomId = 'room_' + allUids.join('_');

  // check if room already exists
  if((await getDoc(doc(db,'roomsMeta',roomId))).exists){
    // simply join: create roomsMeta entry for self if not present (it exists). Open it
    closeModal(newChatModal);
    switchRoom(roomId);
    return;
  }

  // create chatRequest doc for all invited
  const toUids = selectedUids; // invited others
  const toNames = selectedNames;
  const req = {
    fromUid: currentUser.uid,
    fromName: username,
    toUids,
    toNames,
    roomId,
    label: groupLabel.value.trim() || ([username, ...toNames].slice(0,6).join(', ')),
    accepted: Object.fromEntries(toUids.map(uid => [uid, false])),
    createdAt: serverTimestamp()
  };
  await addDoc(collection(db,'chatRequests'), req);
  createMsg.textContent = 'Request sent';
  setTimeout(()=>{ closeModal(newChatModal); createMsg.textContent=''; }, 900);
};

/* SUBSCRIBE to requests where I'm in toUids */
let requestsUnsub = null;
function subscribeRequests(){
  if(requestsUnsub) requestsUnsub();
  const q = query(collection(db,'chatRequests'), orderBy('createdAt','desc'));
  requestsUnsub = onSnapshot(q, snap=>{
    const myReqs = [];
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      const id = docSnap.id;
      if(Array.isArray(d.toUids) && d.toUids.includes(currentUser.uid)){
        myReqs.push({ id, ...d });
      }
    });
    renderRequestIndicator(myReqs.length);
    renderRequestsList(myReqs);
  });
}

/* render request indicator */
function renderRequestIndicator(n){
  if(n>0){ reqCount.style.display='inline-block'; reqCount.textContent = n; } else { reqCount.style.display='none'; }
}

/* populate requests modal */
function renderRequestsList(list){
  requestsList.innerHTML = '';
  if(list.length===0){ requestsList.textContent = 'No pending requests'; return; }
  list.forEach(r=>{
    const item = document.createElement('div'); item.className='user-item';
    const left = document.createElement('div'); left.innerHTML = `<strong>${r.fromName}</strong> invites you to "${r.label}"`;
    const right = document.createElement('div');
    const accept = document.createElement('button'); accept.textContent='Accept'; accept.style.marginRight='6px';
    const reject = document.createElement('button'); reject.textContent='Reject';
    accept.onclick = ()=> respondRequest(r.id, true);
    reject.onclick = ()=> respondRequest(r.id, false);
    right.appendChild(accept); right.appendChild(reject);
    item.appendChild(left); item.appendChild(right);
    requestsList.appendChild(item);
  });
}

/* open requests modal */
requestsBtn.onclick = ()=> openModal(requestsModal);
closeReq.onclick = ()=> closeModal(requestsModal);

/* respond to request (accept or reject) */
async function respondRequest(requestId, accept){
  const reqRef = doc(db,'chatRequests',requestId);
  const docSnap = await getDoc(reqRef);
  if(!docSnap.exists()) return alert('Request missing');
  const data = docSnap.data();
  if(!data.toUids || !data.roomId) return alert('Invalid request');

  if(!accept){
    // remove my slot and mark rejected (we simply remove request doc or mark rejected for all)
    // simplest: delete request doc (means canceled) -- inviter may retry
    await deleteDoc(reqRef);
    return;
  }

  // accept: set accepted[currentUser.uid] = true
  const accepted = data.accepted || {};
  accepted[currentUser.uid] = true;
  await updateDoc(reqRef, { accepted });

  // re-fetch to see if all accepted
  const updated = await getDoc(reqRef); if(!updated.exists()) return;
  const ud = updated.data();
  const all = ud.toUids.every(uid => ud.accepted && ud.accepted[uid]);

  if(all){
    // create roomsMeta if not exists
    const members = [ud.fromUid, ...ud.toUids].sort();
    const roomId = ud.roomId;
    const metaRef = doc(db,'roomsMeta', roomId);
    if(!(await getDoc(metaRef)).exists()){
      await setDoc(metaRef, { label: ud.label || `Chat ${roomId}`, members, lastUpdated: serverTimestamp() });
    }
    // remove the request doc
    await deleteDoc(reqRef);
  }
}

/* SUBSCRIBE to rooms' messages notification (so we can show push) */
function subscribeRequests(){ /* already defined above; kept for readability */ }

/* Settings modal */
settingsBtn.onclick = ()=> document.getElementById('settingsModal').style.display='flex';
closeSettingsBtn.onclick = ()=> document.getElementById('settingsModal').style.display='none';
logoutBtn.onclick = async ()=> { await signOut(auth); window.location.href='login.html'; };

/* theme select handling (persist) */
themeSelect.value = localStorage.getItem('theme') || 'light';
themeSelect.onchange = (e)=>{ document.body.setAttribute('data-theme', e.target.value); localStorage.setItem('theme', e.target.value); };

/* Requests subscription already set above in onAuthStateChanged */

/* helper to open newChat modal with preselected users */
function openNewChatModal(preselectUsernames=[]){
  // ensure createUsers is built
  buildCreateUsers().then(()=>{
    // preselect if names provided
    Array.from(createUsers.querySelectorAll('input[type=checkbox]')).forEach(cb=>{
      cb.checked = preselectUsernames.includes(cb.dataset.username);
    });
    openModal(newChatModal);
  });
}

/* small helper - we used buildCreateUsers earlier; expose it */
window.openNewChatModal = openNewChatModal;

/* initial focus safety */
document.addEventListener('DOMContentLoaded', ()=>{ /* nothing else */ });
</script>
</body>
</html>
