// Firebase imports (same as before)
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, set } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

// Firebase config
const firebaseConfig = { /* your config */ };
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

let currentUser = null;
let tempUserId = "guest_" + Math.random().toString(36).substring(2,10); // temporary UID
let currentRoom = "Global";

// Auto-login or anonymous
onAuthStateChanged(auth, async (user) => {
  if(user){
    currentUser = user;
    loginBtn.style.display = "none";
  } else {
    currentUser = { uid: tempUserId }; // anonymous temp user
    loginBtn.style.display = "inline-block";
  }
  initRooms();
});

// Send message (anyone can send)
sendBtn.addEventListener("click", () => {
  const text = msgInput.value.trim();
  if(!text) return;
  msgInput.value = "";

  const senderId = currentUser.uid;
  if(currentRoom === "Global"){
    push(ref(db,"global"), { sender: senderId, text });
  } else {
    const roomRef = ref(db, `private/${currentRoom}`);
    push(roomRef, { sender: senderId, text, roomName: currentRoom, participants: currentRoom.split("_") });
  }
});

// Login button (optional login)
loginBtn.addEventListener("click", async () => {
  const email = prompt("Enter email (or username)"); 
  const password = prompt("Enter password"); 
  try{
    const userCredential = await signInWithEmailAndPassword(auth,email,password);
    currentUser = userCredential.user;
    loginBtn.style.display = "none";
    alert("Logged in as " + currentUser.uid);
  } catch(e){
    alert("Login failed: "+e.message);
  }
});
