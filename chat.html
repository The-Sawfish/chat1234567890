<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Hybrid Chat ‚Äî Firebase</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<style>
  :root {
    --bg:#f5f7fa; --sidebar:#2c3e50; --sidebar-active:#34495e; --accent:#3498db;
    --text:#222; --card:#fff; --self:#2ecc71; --other:#bdc3c7;
  }
  [data-theme="dark"]{
    --bg:#0f1112; --sidebar:#16202b; --sidebar-active:#25343e; --accent:#256aa2;
    --text:#eaeef0; --card:#151718; --self:#27ae60; --other:#4b5563;
  }
  [data-theme="sunset"]{
    --bg:#ffebe6; --sidebar:#d35400; --sidebar-active:#e67e22; --accent:#e74c3c;
    --text:#2c3e50; --card:#fff3f0; --self:#e67e22; --other:#f39c12;
  }
  [data-theme="forest"]{
    --bg:#eafbea; --sidebar:#14532d; --sidebar-active:#166534; --accent:#22c55e;
    --text:#1a1a1a; --card:#f0fff4; --self:#16a34a; --other:#bbf7d0;
  }
  [data-theme="ocean"]{
    --bg:#e0f7fa; --sidebar:#006064; --sidebar-active:#00838f; --accent:#00acc1;
    --text:#00363a; --card:#ffffff; --self:#0097a7; --other:#b2ebf2;
  }
  [data-theme="midnight"]{
    --bg:#071124; --sidebar:#09203f; --sidebar-active:#0b3b5a; --accent:#375a7f;
    --text:#e6f0fa; --card:#0b1420; --self:#2a9df4; --other:#1b2b44;
  }

  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter, Arial, sans-serif}
  .stage{display:flex;justify-content:center;align-items:center;height:100vh;padding:12px;box-sizing:border-box}
  #app{display:flex;width:95%;max-width:1000px;height:84vh;border-radius:12px;overflow:hidden;box-shadow:0 8px 30px rgba(2,6,23,.12)}
  #sidebar{width:220px;background:var(--sidebar);color:#fff;padding:12px;box-sizing:border-box;display:flex;flex-direction:column}
  #sidebar h3{margin:0 0 12px;text-align:center;font-size:16px}
  .room-btn{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;border:0;background:transparent;color:#fff;margin:6px 0;cursor:pointer;font-weight:600}
  .room-btn:hover{background:rgba(255,255,255,0.04)}
  .room-btn.active{background:var(--sidebar-active)}
  .room-label{flex:1;text-align:left;padding-right:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .controls{margin-top:auto;display:flex;flex-direction:column;gap:8px}
  .btn-flat{background:var(--accent);border:0;color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700}
  .small-flat{background:transparent;border:1px solid rgba(255,255,255,0.08);color:#fff;padding:6px 8px;border-radius:8px;cursor:pointer}
  #main{flex:1;display:flex;flex-direction:column;background:var(--card)}
  header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--accent);color:#fff}
  #title{font-weight:800}
  #subtitle{font-size:12px;opacity:.95}
  #chat{flex:1;overflow:auto;padding:14px;box-sizing:border-box;background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent)}
  .msg{clear:both;max-width:72%;padding:10px 12px;border-radius:12px;margin:8px 0;word-break:break-word}
  .self{background:var(--self);color:#fff;float:right;border-bottom-right-radius:4px}
  .other{background:var(--other);float:left;color:#111;border-bottom-left-radius:4px}
  .meta{font-size:11px;color:rgba(0,0,0,0.45);margin-top:6px}
  footer{display:flex;gap:8px;padding:10px;background:transparent;border-top:1px solid rgba(0,0,0,0.06)}
  input.message{flex:1;padding:10px;border-radius:10px;border:1px solid #d6dbe0;font-size:14px}
  button.send{padding:10px 12px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
</style>
</head>
<body data-theme="light">
<div class="stage">
  <div id="app">
    <aside id="sidebar">
      <h3>Chats</h3>
      <div id="roomsContainer"></div>
      <div class="controls">
        <button id="settings" class="small-flat">‚öôÔ∏è Settings</button>
      </div>
    </aside>
    <main id="main">
      <header>
        <div>
          <div id="title">‚Äî</div>
          <div id="subtitle">‚Äî</div>
        </div>
      </header>
      <section id="chat"></section>
      <footer>
        <input id="msgInput" class="message" placeholder="Type a message‚Ä¶">
        <button id="sendBtn" class="send">Send</button>
      </footer>
    </main>
  </div>
</div>

<!-- Settings Modal: replaced with dropdown + improved close contrast -->
<div id="settingsModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);align-items:center;justify-content:center;">
  <div style="background:var(--card);padding:20px;border-radius:12px;min-width:320px;color:var(--text);box-shadow:0 8px 24px rgba(0,0,0,0.18)">
    <h3 style="margin-top:0">‚öôÔ∏è Settings</h3>

    <label for="themeSelect" style="display:block;margin-top:8px;font-weight:600">Theme</label>
    <select id="themeSelect" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;margin-top:8px;color:var(--text);background:var(--card)">
      <option value="light">Light</option>
      <option value="dark">Dark</option>
      <option value="sunset">Sunset</option>
      <option value="forest">Forest</option>
      <option value="ocean">Ocean</option>
      <option value="midnight">Midnight</option>
    </select>

    <div style="margin-top:14px;display:flex;gap:8px;flex-direction:column">
      <button id="logout" class="btn-flat" style="background:#e74c3c">Logout</button>
      <!-- Close button: ensure high contrast so it's always visible -->
      <button id="closeSettings" class="btn-flat" style="background:var(--accent);color:#fff">Close</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA0m8RzkSmIgdPxvyMqW6SKsNLa_EvZJ9w",
  authDomain: "hybridchat-8a96c.firebaseapp.com",
  projectId: "hybridchat-8a96c",
  storageBucket: "hybridchat-8a96c.firebasestorage.app",
  messagingSenderId: "8350065462",
  appId: "1:8350065462:web:779c8fd3c81acaeebc8997"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// check login (force login.html if no username)
let username = sessionStorage.getItem("username");
if (!username) {
  window.location.href = "login.html"; // redirect
}

// elements
const roomsContainer = document.getElementById("roomsContainer");
const chatEl = document.getElementById("chat");
const titleEl = document.getElementById("title");
const subtitleEl = document.getElementById("subtitle");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");

let currentRoom = "Global";

function renderRooms() {
  roomsContainer.innerHTML = "";
  const globalBtn = document.createElement("button");
  globalBtn.className = "room-btn active";
  globalBtn.innerHTML = `<span class="room-label">üåç Global</span>`;
  roomsContainer.appendChild(globalBtn);
}
renderRooms();

function appendMsgDOM(obj) {
  const d=document.createElement("div");
  d.className="msg "+(obj.user===username?"self":"other");
  const text=document.createElement("div"); text.innerText=obj.text;
  const meta=document.createElement("div"); meta.className="meta"; meta.innerText=`${obj.user} ‚Ä¢ ${new Date(obj.time).toLocaleTimeString()}`;
  d.appendChild(text); d.appendChild(meta); chatEl.appendChild(d);
}

function renderChat() {
  titleEl.innerText = "üåç Global Chat";
  subtitleEl.innerText = "Public chat room";
  chatEl.innerHTML="";
  const q=query(collection(db,"rooms",currentRoom,"messages"),orderBy("time"));
  onSnapshot(q,(snap)=>{
    chatEl.innerHTML="";
    snap.forEach(doc=>appendMsgDOM(doc.data()));
    chatEl.scrollTop=chatEl.scrollHeight;
  });
}
renderChat();

async function sendMessage(text){
  await addDoc(collection(db,"rooms",currentRoom,"messages"),{
    user: username,
    text,
    time: Date.now()
  });
}

sendBtn.onclick=()=>{
  const text=msgInput.value.trim();
  if(!text) return;
  sendMessage(text);
  msgInput.value="";
};

msgInput.addEventListener("keydown",(e)=>{
  if(e.key==="Enter") sendBtn.click();
});

// settings modal interactions
document.getElementById("settings").onclick=()=>{
  document.getElementById("settingsModal").style.display="flex";
};

// logout
document.getElementById("logout").onclick=()=>{
  sessionStorage.clear();
  location.href="login.html";
};

// theme select handling (dropdown)
const themeSelect = document.getElementById("themeSelect");
themeSelect.addEventListener("change", (e) => {
  const next = e.target.value;
  document.body.setAttribute("data-theme", next);
  localStorage.setItem("theme", next);
});
// set initial select value to saved theme
const savedTheme = localStorage.getItem("theme");
if(savedTheme) {
  document.body.setAttribute("data-theme", savedTheme);
  // try to set the select's value (if present)
  try { themeSelect.value = savedTheme; } catch(e){}
}

// close settings (contrast-safe button)
document.getElementById("closeSettings").onclick = ()=>{
  document.getElementById("settingsModal").style.display="none";
};

// Notifications (same behavior)
if ("Notification" in window && Notification.permission !== "denied") {
  Notification.requestPermission();
}
function showNotification(msg) {
  if (Notification.permission === "granted" && msg.user !== username) {
    new Notification("New message from " + msg.user, { body: msg.text });
  }
}
const q2=query(collection(db,"rooms",currentRoom,"messages"),orderBy("time"));
onSnapshot(q2,(snap)=>{
  snap.docChanges().forEach(change=>{
    if(change.type==="added"){
      showNotification(change.doc.data());
    }
  });
});
</script>
</body>
</html>
