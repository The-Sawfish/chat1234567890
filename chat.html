<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hybrid Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyA0m8RzkSmIgdPxvyMqW6SKsNLa_EvZJ9w",
  authDomain: "hybridchat-8a96c.firebaseapp.com",
  projectId: "hybridchat-8a96c",
  storageBucket: "hybridchat-8a96c.firebasestorage.app",
  messagingSenderId: "8350065462",
  appId: "1:8350065462:web:779c8fd3c81acaeebc8997"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// UI refs
const chatEl = document.getElementById("chat");
const roomsContainer = document.getElementById("roomsContainer");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const roomTitle = document.getElementById("roomTitle");
const settingsBtn = document.getElementById("settingsBtn");
const settingsModal = document.getElementById("settingsModal");
const closeSettings = document.getElementById("closeSettings");
const themeToggle = document.getElementById("themeToggle");
const logoutBtn = document.getElementById("logoutBtn");
const newChatBtn = document.getElementById("newChatBtn");

let currentUser = null;
let currentRoom = null;
let rooms = {}; // {roomId: {label, members}}
let unsubscribeRoom = null;

// Show UI after login
document.getElementById("main").style.display = "none";
document.getElementById("sidebar").style.display = "none";

// ---- AUTH ----
onAuthStateChanged(auth, async (user) => {
  if(!user) return;
  currentUser = user;
  document.getElementById("main").style.display = "flex";
  document.getElementById("sidebar").style.display = "flex";
  msgInput.disabled = false;
  sendBtn.disabled = false;
  await loadRooms();
  loadTheme();
  requestPermissionNotification();
});

// ---- LOAD ROOMS (global + private/group) ----
async function loadRooms(){
  roomsContainer.innerHTML = "";
  rooms = {};

  // Global chat
  rooms["global"] = {label:"üåç Global Chat", members:[]};

  // Load user's private/group chats
  const roomsSnap = await getDoc(doc(db,"userRooms",currentUser.uid));
  if(roomsSnap.exists()){
    const userRooms = roomsSnap.data();
    for(const [id,data] of Object.entries(userRooms)){
      rooms[id] = {label:data.label,members:data.members || []};
    }
  }

  for(const [id,data] of Object.entries(rooms)){
    addRoomButton(id,data.label);
  }

  if(!currentRoom) loadRoom(Object.keys(rooms)[0]);
}

// ---- ADD ROOM BUTTON ----
function addRoomButton(id,label){
  const btn = document.createElement("button");
  btn.className = "room-btn" + (id === currentRoom ? " active" : "");
  btn.innerText = label;
  btn.onclick = () => loadRoom(id);
  roomsContainer.appendChild(btn);
}

// ---- LOAD ROOM ----
function loadRoom(roomId){
  currentRoom = roomId;
  roomTitle.innerText = rooms[roomId]?.label || roomId;
  chatEl.innerHTML = "";

  if(unsubscribeRoom) unsubscribeRoom();

  const q = query(collection(db,"rooms",roomId,"messages"), orderBy("createdAt"));
  unsubscribeRoom = onSnapshot(q, snapshot => {
    chatEl.innerHTML = "";
    snapshot.forEach(docSnap => {
      const msg = docSnap.data();
      appendMessage(msg);
    });
    chatEl.scrollTop = chatEl.scrollHeight;
  });

  // Highlight active room button
  document.querySelectorAll(".room-btn").forEach(b => b.classList.remove("active"));
  const activeBtn = Array.from(document.querySelectorAll(".room-btn")).find(b => b.innerText===rooms[roomId].label);
  if(activeBtn) activeBtn.classList.add("active");
}

// ---- SEND MESSAGE ----
sendBtn.onclick = async () => {
  const text = msgInput.value.trim();
  if(!text || !currentRoom) return;
  await addDoc(collection(db,"rooms",currentRoom,"messages"),{
    text,
    from: currentUser.uid,
    createdAt: serverTimestamp()
  });
  msgInput.value = "";
}

// ---- APPEND MESSAGE ----
function appendMessage(msg){
  const div = document.createElement("div");
  div.className = "msg " + (msg.from === currentUser.uid ? "self" : "other");
  div.innerHTML = `<div>${msg.text}</div>
                   <div class="meta">${msg.from} ‚Ä¢ ${msg.createdAt?.toDate?.()?.toLocaleTimeString() || ""}</div>`;
  chatEl.appendChild(div);

  if(msg.from !== currentUser.uid && Notification.permission === "granted"){
    new Notification("New message", {body: msg.text});
  }
}

// ---- CREATE PRIVATE/GROUP CHAT ----
async function createChat(userIds,label){
  const allIds = [currentUser.uid,...userIds].sort();
  const roomId = `chat_${allIds.join("_")}`;
  rooms[roomId] = {label,members:allIds};

  // Save room for each member
  for(const uid of allIds){
    await setDoc(doc(db,"userRooms",uid), {[roomId]:{label,members:allIds}}, {merge:true});
  }

  addRoomButton(roomId,label);
  loadRoom(roomId);
}

// ---- SETTINGS ----
settingsBtn.onclick = ()=> settingsModal.style.display = "flex";
closeSettings.onclick = ()=> settingsModal.style.display = "none";
themeToggle.onclick = ()=>{
  const body = document.body;
  const theme = body.dataset.theme==="dark"?"light":"dark";
  body.dataset.theme = theme;
  localStorage.setItem("theme",theme);
};
logoutBtn.onclick = ()=> signOut(auth);

// ---- NEW CHAT BUTTON ----
newChatBtn.onclick = async () => {
  const emails = prompt("Enter comma-separated emails for the chat (other users):");
  if(!emails) return;
  const label = prompt("Enter a chat name:");
  if(!label) return;

  // Convert emails to UID (simple version)
  const userIds = emails.split(",").map(e=>e.trim()); // Replace with real UID lookup in production
  createChat(userIds,label);
}

// ---- LOAD THEME ----
function loadTheme(){
  const saved = localStorage.getItem("theme") || "light";
  document.body.dataset.theme = saved;
}

// ---- NOTIFICATIONS ----
function requestPermissionNotification(){
  if("Notification" in window && Notification.permission==="default"){
    Notification.requestPermission();
  }
}
</script>

<style>
:root{
  --bg:#f5f7fa; --sidebar:#2c3e50; --sidebar-active:#34495e; --accent:#3498db;
  --text:#222; --card:#fff; --self:#2ecc71; --other:#bdc3c7;
}
[data-theme="dark"]{
  --bg:#0f1112; --sidebar:#16202b; --sidebar-active:#25343e; --accent:#256aa2;
  --text:#eaeef0; --card:#151718; --self:#27ae60; --other:#4b5563;
}
html,body{margin:0;height:100%;font-family:Inter,Arial,sans-serif;background:var(--bg);color:var(--text);}
.stage{display:flex;justify-content:center;align-items:center;height:100vh;padding:10px;box-sizing:border-box;}
#app{display:flex;width:95%;max-width:1000px;height:85vh;border-radius:12px;overflow:hidden;box-shadow:0 8px 30px rgba(0,0,0,0.1);}
#sidebar{width:250px;background:var(--sidebar);color:#fff;padding:12px;display:flex;flex-direction:column;}
#sidebar h3{margin:0 0 12px;text-align:center;font-size:16px;}
.room-btn{display:flex;align-items:center;justify-content:center;padding:8px;border-radius:8px;border:0;background:transparent;color:#fff;margin:6px 0;cursor:pointer;font-weight:600;}
.room-btn.active{background:var(--sidebar-active);}
#main{flex:1;display:flex;flex-direction:column;background:var(--card);}
header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--accent);color:#fff;}
#chat{flex:1;overflow:auto;padding:14px;box-sizing:border-box;background:linear-gradient(180deg,rgba(0,0,0,0.02),transparent);}
.msg{clear:both;max-width:75%;padding:10px 12px;border-radius:12px;margin:8px 0;word-break:break-word;}
.self{background:var(--self);color:#fff;float:right;border-bottom-right-radius:4px;}
.other{background:var(--other);float:left;color:#111;border-bottom-left-radius:4px;}
.meta{font-size:11px;color:rgba(0,0,0,0.45);margin-top:4px;}
footer{display:flex;gap:8px;padding:10px;background:transparent;border-top:1px solid rgba(0,0,0,0.06);}
input.message{flex:1;padding:10px;border-radius:10px;border:1px solid #d6dbe0;font-size:14px;}
button.send, button#newChatBtn{padding:10px 12px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:700;cursor:pointer;}
#settingsModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;}
#settingsContent{background:var(--card);padding:20px;border-radius:12px;width:90%;max-width:400px;display:flex;flex-direction:column;}
button#logoutBtn, button#closeSettings, button#themeToggle{margin-top:10px;}
</style>

<body data-theme="light">
<div class="stage">
<div id="app">
  <aside id="sidebar">
    <h3>Chats</h3>
    <div id="roomsContainer"></div>
    <button id="newChatBtn" class="room-btn">‚ûï New Chat</button>
    <button id="settingsBtn" class="room-btn">‚öôÔ∏è Settings</button>
  </aside>

  <main id="main">
    <header>
      <div id="roomTitle">‚Äî</div>
    </header>
    <section id="chat"></section>
    <footer>
      <input id="msgInput" class="message" placeholder="Type a message‚Ä¶">
      <button id="sendBtn" class="send">Send</button>
    </footer>
  </main>
</div>
</div>

<div id="settingsModal">
  <div id="settingsContent">
    <h3>Settings</h3>
    <button id="themeToggle">Toggle Theme</button>
    <button id="logoutBtn">Logout</button>
    <button id="closeSettings">Close</button>
  </div>
</div>
</body>
</html>
