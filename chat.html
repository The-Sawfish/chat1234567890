<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Hybrid Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<style>
html,body {
  margin:0;
  padding:0;
  font-family:Arial,sans-serif;
  background:#f0f2f5;
  width:100vw;
  height:100vh;
  overflow:hidden;
  display:flex;
}

/* Sidebar */
#sidebar {
  width:150px;
  background:#4a90e2;
  color:white;
  display:flex;
  flex-direction:column;
  overflow-y:auto;
  padding-bottom:10px;
  flex-shrink:0;
}
#sidebar h3 {
  text-align:center;
  margin:10px 0;
}
.room-btn {
  padding:8px;
  border:none;
  background:#357ABD;
  color:white;
  margin:3px;
  cursor:pointer;
  border-radius:6px;
  font-size:12px;
  text-align:left;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.room-btn.active { background:#285680; }

/* Main area */
#main {
  flex:1;
  display:flex;
  flex-direction:column;
  height:100vh;
  width: calc(100vw - 150px);
}

/* Header */
header {
  background:#357ABD;
  color:white;
  padding:10px;
  text-align:center;
  font-weight:bold;
  font-size:14px;
  flex-shrink:0;
}

/* Chat box */
#chat {
  flex:1;
  overflow-y:auto;
  padding:6px;
  background:#fafafa;
  font-size:12px;
  word-wrap: break-word; /* prevent horizontal overflow */
}

/* Messages */
#chat div { margin-bottom:3px; }
.peer-label { font-weight:bold; }

/* Footer */
footer {
  display:flex;
  padding:4px;
  background:white;
  flex-shrink:0;
  box-sizing:border-box;
}
input[type=text] {
  flex:1;
  padding:6px;
  border-radius:6px;
  border:1px solid #ccc;
  font-size:12px;
}
button {
  padding:6px 8px;
  border-radius:6px;
  border:none;
  background:#4a90e2;
  color:white;
  font-weight:bold;
  cursor:pointer;
  font-size:12px;
  white-space:nowrap;
}
button:disabled { opacity:0.5; cursor:not-allowed; }

/* Responsive */
@media(max-width:500px){
  #sidebar { width:120px; font-size:11px; }
  #main { width: calc(100vw - 120px); }
  header { font-size:12px; }
  #chat { font-size:11px; padding:4px; }
  button,input { font-size:11px; padding:4px; }
}
</style>
</head>
<body>

<div id="sidebar">
<h3>Chats</h3>
<button class="room-btn active" data-room="Global">Global</button>
</div>

<div id="main">
<header id="header"></header>
<div id="chat"></div>
<footer>
<input type="text" id="msgInput" placeholder="Message" disabled>
<button id="sendBtn" disabled>Send</button>
</footer>
</div>

<script>
// --- Redirect if not logged in ---
const username=sessionStorage.getItem('username');
if(!username) window.location.href='login.html';

// --- Initialize ---
let currentRoom='Global';
document.getElementById('header').innerText=username+' | Room: '+currentRoom;

const chatBox=document.getElementById('chat');
const msgInput=document.getElementById('msgInput');
const sendBtn=document.getElementById('sendBtn');
const sidebar=document.getElementById('sidebar');

let peer=new Peer(username);
let connections={}; // peerId => conn
let rooms={'Global':[]};

// Load last 20 global messages from localStorage
rooms['Global']=JSON.parse(localStorage.getItem('globalMessages')||'[]');
function saveGlobalMessages(){ localStorage.setItem('globalMessages', JSON.stringify(rooms['Global'].slice(-20))); }

// --- Functions ---
function appendMessage(msg,who='Peer'){
  if(!rooms[currentRoom]) rooms[currentRoom]=[];
  rooms[currentRoom].push({who,msg});
  if(currentRoom==='Global') saveGlobalMessages();
  chatBox.innerHTML='';
  rooms[currentRoom].forEach(m=>{
    chatBox.innerHTML+=`<div><span class="peer-label">${m.who}:</span> ${m.msg}</div>`;
  });
  chatBox.scrollTop=chatBox.scrollHeight;
}

function broadcast(msg){
  for(let user in connections){
    if(connections[user].open) connections[user].send({from:username,text:msg,room:'Global'});
  }
}

function sendPrivate(target,msg){
  if(connections[target] && connections[target].open)
    connections[target].send({from:username,text:msg,room:target});
}

function setupConnection(conn){
  connections[conn.peer]=conn;

  // Add private chat if new
  if(conn.peer!==username && !document.querySelector(`.room-btn[data-room="${conn.peer}"]`)){
    const btn=document.createElement('button');
    btn.className='room-btn';
    btn.dataset.room=conn.peer;
    btn.innerText=conn.peer;
    btn.onclick=()=>switchRoom(conn.peer);
    sidebar.appendChild(btn);
    rooms[conn.peer]=[];
  }

  conn.on('open',()=>{
    appendMessage('Connected to '+conn.peer,'System');
    msgInput.disabled=false;
    sendBtn.disabled=false;
  });

  conn.on('data',data=>{
    if(!rooms[data.room]) rooms[data.room]=[];
    rooms[data.room].push({who:data.from,msg:data.text});
    if(currentRoom===data.room) appendMessage(data.text,data.from);
  });

  conn.on('close',()=>{
    appendMessage('Disconnected from '+conn.peer,'System');
    delete connections[conn.peer];
  });
}

function switchRoom(room){
  document.querySelectorAll('.room-btn').forEach(b=>b.classList.remove('active'));
  const btn=document.querySelector(`.room-btn[data-room="${room}"]`);
  if(btn) btn.classList.add('active');
  currentRoom=room;
  document.getElementById('header').innerText=username+' | Room: '+currentRoom;
  chatBox.innerHTML='';
  if(!rooms[room]) rooms[room]=[];
  rooms[room].forEach(m=>{
    chatBox.innerHTML+=`<div><span class="peer-label">${m.who}:</span> ${m.msg}</div>`;
  });
}

// --- PeerJS ---
peer.on('open',id=>{
  appendMessage('Connected as '+id,'System');
  msgInput.disabled=false;
  sendBtn.disabled=false;

  // Auto-connect to all users in localStorage
  let users=JSON.parse(localStorage.getItem('users')||'{}');
  for(let u in users){
    if(u!==username){
      const conn=peer.connect(u);
      setupConnection(conn);
    }
  }
});

peer.on('connection',conn=>{ setupConnection(conn); });

// --- Sending ---
sendBtn.onclick=()=>{
  const msg=msgInput.value.trim();
  if(!msg) return;
  appendMessage(msg,'You');
  if(currentRoom==='Global') broadcast(msg);
  else sendPrivate(currentRoom,msg);
  msgInput.value='';
};

</script>
</body>
</html>
