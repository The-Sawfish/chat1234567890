<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hybrid Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root {
    --bg:#f5f7fa; --sidebar:#2c3e50; --sidebar-active:#34495e; --accent:#3498db;
    --text:#222; --card:#fff; --self:#2ecc71; --other:#bdc3c7;
  }
  [data-theme="dark"]{
    --bg:#0f1112; --sidebar:#16202b; --sidebar-active:#25343e; --accent:#256aa2;
    --text:#eaeef0; --card:#151718; --self:#27ae60; --other:#4b5563;
  }
  [data-theme="red"]{ --accent:#e74c3c; --self:#c0392b; }
  [data-theme="green"]{ --accent:#2ecc71; --self:#27ae60; }
  [data-theme="purple"]{ --accent:#9b59b6; --self:#8e44ad; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter, Arial, sans-serif;}
  .stage{display:flex;justify-content:center;align-items:center;height:100vh;padding:12px;box-sizing:border-box;}
  #app{display:flex;width:95%;max-width:1000px;height:84vh;border-radius:12px;overflow:hidden;box-shadow:0 8px 30px rgba(2,6,23,.12);}
  #sidebar{width:220px;background:var(--sidebar);color:#fff;padding:12px;display:flex;flex-direction:column;}
  #sidebar h3{margin:0 0 12px;text-align:center;font-size:16px;}
  .room-btn{display:flex;align-items:center;justify-content:center;padding:8px;border-radius:8px;border:0;background:transparent;color:#fff;margin:6px 0;cursor:pointer;font-weight:600;}
  .room-btn.active{background:var(--sidebar-active);}
  #main{flex:1;display:flex;flex-direction:column;background:var(--card);}
  header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--accent);color:#fff;}
  #chat{flex:1;overflow:auto;padding:14px;box-sizing:border-box;background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent);}
  .msg{clear:both;max-width:72%;padding:10px 12px;border-radius:12px;margin:8px 0;word-break:break-word;}
  .self{background:var(--self);color:#fff;float:right;border-bottom-right-radius:4px;}
  .other{background:var(--other);float:left;color:#111;border-bottom-left-radius:4px;}
  .meta{font-size:11px;color:rgba(0,0,0,0.45);margin-top:6px;}
  footer{display:flex;gap:8px;padding:10px;background:transparent;border-top:1px solid rgba(0,0,0,0.06);}
  input.message{flex:1;padding:10px;border-radius:10px;border:1px solid #d6dbe0;font-size:14px;}
  button.send{padding:10px 12px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:700;cursor:pointer;}
  #settingsModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);align-items:center;justify-content:center;}
  #settingsContent{background:var(--card);padding:20px;border-radius:12px;min-width:280px;color:var(--text);}
  select{width:100%;padding:8px;margin:10px 0;border-radius:8px;border:1px solid #ccc;}
  button.closeSettings{margin-top:10px;background:#e74c3c;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;}
</style>
</head>
<body data-theme="light">
<div class="stage">
  <div id="app">
    <aside id="sidebar">
      <h3>Chats</h3>
      <div id="roomsContainer"></div>
      <button id="newChatBtn" class="room-btn">+ Private / Group</button>
      <button id="settingsBtn" class="room-btn">‚öôÔ∏è Settings</button>
    </aside>
    <main id="main">
      <header>
        <div id="roomTitle">Global</div>
      </header>
      <section id="chat"></section>
      <footer>
        <input id="msgInput" class="message" placeholder="Type a message‚Ä¶">
        <button id="sendBtn" class="send">Send</button>
      </footer>
    </main>
  </div>
</div>

<div id="settingsModal">
  <div id="settingsContent">
    <h3>Settings</h3>
    <label for="themeSelect">Choose Theme:</label>
    <select id="themeSelect">
      <option value="light">Light</option>
      <option value="dark">Dark</option>
      <option value="red">Red</option>
      <option value="green">Green</option>
      <option value="purple">Purple</option>
    </select>
    <button id="closeSettings" class="closeSettings">Close</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA0m8RzkSmIgdPxvyMqW6SKsNLa_EvZJ9w",
  authDomain: "hybridchat-8a96c.firebaseapp.com",
  projectId: "hybridchat-8a96c",
  storageBucket: "hybridchat-8a96c.firebasestorage.app",
  messagingSenderId: "8350065462",
  appId: "1:8350065462:web:779c8fd3c81acaeebc8997"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let currentRoom = "Global";
const rooms = { Global: "üåç Global" };
const roomsContainer = document.getElementById("roomsContainer");
const chatEl = document.getElementById("chat");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const settingsBtn = document.getElementById("settingsBtn");
const settingsModal = document.getElementById("settingsModal");
const closeSettings = document.getElementById("closeSettings");
const themeSelect = document.getElementById("themeSelect");
const newChatBtn = document.getElementById("newChatBtn");

// --- Check login ---
onAuthStateChanged(auth, user => {
  if(!user) window.location.href="login.html";
  else {
    currentUser=user;
    renderRooms();
    switchRoom("Global");
    requestNotificationPermission();
  }
});

// --- Render Rooms ---
function renderRooms(){
  roomsContainer.innerHTML="";
  for(const [id,label] of Object.entries(rooms)){
    const btn=document.createElement("button");
    btn.className="room-btn"+(id===currentRoom?" active":"");
    btn.innerText=label;
    btn.onclick=()=>switchRoom(id);
    roomsContainer.appendChild(btn);
  }
}

// --- Switch Room ---
function switchRoom(roomId){
  currentRoom=roomId;
  renderRooms();
  chatEl.innerHTML="";
  const q=query(collection(db,"rooms",roomId,"messages"),orderBy("createdAt"));
  onSnapshot(q,snap=>{
    chatEl.innerHTML="";
    snap.forEach(docSnap=>{
      const msg=docSnap.data();
      const div=document.createElement("div");
      div.className="msg "+(msg.from===currentUser.email?"self":"other");
      div.innerHTML=`<div>${msg.text}</div><div class="meta">${msg.from} ‚Ä¢ ${msg.createdAt?.toDate().toLocaleTimeString()||""}</div>`;
      chatEl.appendChild(div);
      if(msg.from!==currentUser.email && Notification.permission==="granted"){
        new Notification(`New message from ${msg.from}`,{body:msg.text});
      }
    });
    chatEl.scrollTop=chatEl.scrollHeight;
  });
}

// --- Send Message ---
sendBtn.onclick=async ()=>{
  const text=msgInput.value.trim();
  if(!text) return;
  await addDoc(collection(db,"rooms",currentRoom,"messages"),{
    text,
    from:currentUser.email,
    createdAt:serverTimestamp()
  });
  msgInput.value="";
};
msgInput.addEventListener("keydown",e=>{if(e.key==="Enter") sendBtn.click();});

// --- Settings ---
settingsBtn.onclick=()=>settingsModal.style.display="flex";
closeSettings.onclick=()=>settingsModal.style.display="none";
themeSelect.onchange=()=>{
  document.body.dataset.theme=themeSelect.value;
  localStorage.setItem("theme",themeSelect.value);
};
const savedTheme=localStorage.getItem("theme");
if(savedTheme){document.body.dataset.theme=savedTheme;themeSelect.value=savedTheme;}

// --- Notification ---
function requestNotificationPermission(){
  if("Notification" in window && Notification.permission==="default")
    Notification.requestPermission();
}

// --- Private / Group Chat ---
newChatBtn.onclick=async ()=>{
  const emails=prompt("Enter email(s) separated by comma (max 5 others):");
  if(!emails) return;
  const emailArr=[...new Set(emails.split(",").map(e=>e.trim()).filter(e=>e && e!==currentUser.email))];
  if(emailArr.length>5){alert("Max 5 users allowed"); return;}
  emailArr.push(currentUser.email); // include self
  const roomId=emailArr.sort().join("_");
  rooms[roomId]="Group: "+emailArr.join(",");
  renderRooms();

  // Send invite document
  for(const e of emailArr){
    if(e!==currentUser.email){
      await setDoc(doc(db,"invites",roomId+"_"+e),{
        roomId,
        from:currentUser.email,
        to:e,
        accepted:false,
        createdAt:serverTimestamp()
      });
    }
  }
  switchRoom(roomId);
};

// --- Check invitations ---
onSnapshot(collection(db,"invites"),snap=>{
  snap.forEach(async docSnap=>{
    const invite=docSnap.data();
    if(invite.to===currentUser?.email && !invite.accepted){
      const accept=confirm(`Invite from ${invite.from} to join room:\n${invite.roomId}\nAccept?`);
      if(accept){
        await setDoc(doc(db,"invites",docSnap.id),{...invite,accepted:true});
        rooms[invite.roomId]="Group: "+invite.roomId.split("_").join(", ");
        renderRooms();
      } else {
        await setDoc(doc(db,"invites",docSnap.id),{...invite,accepted:false});
      }
    }
  });
});
</script>
</body>
</html>
