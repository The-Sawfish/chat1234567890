<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hybrid Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, setDoc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    /* ==== Firebase Config ==== */
    const firebaseConfig = {
      apiKey: "AIzaSyA0m8RzkSmIgdPxvyMqW6SKsNLa_EvZJ9w",
      authDomain: "hybridchat-8a96c.firebaseapp.com",
      projectId: "hybridchat-8a96c",
      storageBucket: "hybridchat-8a96c.firebasestorage.app",
      messagingSenderId: "8350065462",
      appId: "1:8350065462:web:779c8fd3c81acaeebc8997"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let currentRoom = "global";

    /* ==== Auth Enforcement ==== */
    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        currentUser = user;
        loadRoom("global"); // default to global
        renderRooms();
      }
    });

    /* ==== Rooms ==== */
    const rooms = { global: "üåç Global Chat" };

    function renderRooms() {
      const container = document.getElementById("roomsContainer");
      container.innerHTML = "";
      for (const [id, label] of Object.entries(rooms)) {
        const btn = document.createElement("button");
        btn.className = "room-btn" + (id === currentRoom ? " active" : "");
        btn.innerText = label;
        btn.onclick = () => loadRoom(id);
        container.appendChild(btn);
      }
    }

    async function createPrivateRoom(friendEmail) {
      const roomId = [currentUser.email, friendEmail].sort().join("_");
      rooms[roomId] = `üí¨ ${friendEmail}`;
      renderRooms();
      loadRoom(roomId);
    }

    async function createGroupRoom(name, members) {
      const roomId = "group_" + Date.now();
      await setDoc(doc(db, "rooms", roomId), {
        name,
        members,
        createdAt: serverTimestamp()
      });
      rooms[roomId] = `üë• ${name}`;
      renderRooms();
      loadRoom(roomId);
    }

    /* ==== Messages ==== */
    function loadRoom(roomId) {
      currentRoom = roomId;
      document.getElementById("chat").innerHTML = "";
      document.getElementById("roomTitle").innerText = rooms[roomId] || "Chat";

      const q = query(collection(db, "rooms", roomId, "messages"), orderBy("createdAt"));
      onSnapshot(q, snapshot => {
        const chat = document.getElementById("chat");
        chat.innerHTML = "";
        snapshot.forEach(docSnap => {
          const msg = docSnap.data();
          const div = document.createElement("div");
          div.className = "msg " + (msg.from === currentUser.email ? "self" : "other");
          div.innerHTML = `<div>${msg.text}</div><div class="meta">${msg.from} ‚Ä¢ ${msg.createdAt?.toDate().toLocaleTimeString() || ""}</div>`;
          chat.appendChild(div);
        });
        chat.scrollTop = chat.scrollHeight;
      });
    }

    async function sendMessage() {
      const input = document.getElementById("msgInput");
      const text = input.value.trim();
      if (!text) return;
      await addDoc(collection(db, "rooms", currentRoom, "messages"), {
        text,
        from: currentUser.email,
        createdAt: serverTimestamp()
      });
      input.value = "";
    }

    /* ==== Settings ==== */
    function toggleTheme() {
      const body = document.body;
      const theme = body.dataset.theme === "dark" ? "light" : "dark";
      body.dataset.theme = theme;
      localStorage.setItem("theme", theme);
    }

    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("sendBtn").onclick = sendMessage;
      document.getElementById("settingsBtn").onclick = () => document.getElementById("settingsModal").style.display = "block";
      document.getElementById("closeSettings").onclick = () => document.getElementById("settingsModal").style.display = "none";
      document.getElementById("themeToggle").onclick = toggleTheme;
      document.getElementById("logoutBtn").onclick = () => signOut(auth);

      // load saved theme
      const savedTheme = localStorage.getItem("theme") || "light";
      document.body.dataset.theme = savedTheme;
    });

  </script>

  <style>
    :root {
      --bg: #f4f5f7; --sidebar:#2c3e50; --accent:#3498db;
      --text:#222; --self:#2ecc71; --other:#bdc3c7;
    }
    [data-theme="dark"] {
      --bg:#0f1112; --sidebar:#16202b; --accent:#256aa2;
      --text:#eaeef0; --self:#27ae60; --other:#4b5563;
    }
    body { margin:0; height:100vh; font-family:Arial, sans-serif; background:var(--bg); color:var(--text); display:flex; }
    #sidebar { width:220px; background:var(--sidebar); color:#fff; padding:12px; display:flex; flex-direction:column; }
    .room-btn { padding:10px; margin:4px 0; border:none; background:none; color:#fff; text-align:left; cursor:pointer; border-radius:6px; }
    .room-btn.active, .room-btn:hover { background:rgba(255,255,255,0.1); }
    #main { flex:1; display:flex; flex-direction:column; }
    header { background:var(--accent); color:#fff; padding:10px; font-weight:bold; display:flex; justify-content:space-between; align-items:center; }
    #chat { flex:1; padding:12px; overflow-y:auto; }
    .msg { max-width:70%; padding:10px; margin:6px; border-radius:8px; }
    .self { background:var(--self); color:#fff; margin-left:auto; }
    .other { background:var(--other); }
    .meta { font-size:11px; opacity:0.7; margin-top:4px; }
    footer { display:flex; padding:10px; border-top:1px solid #ccc; }
    footer input { flex:1; padding:10px; border-radius:8px; border:1px solid #ccc; }
    footer button { margin-left:8px; padding:10px 14px; border:none; border-radius:8px; background:var(--accent); color:#fff; cursor:pointer; }
    /* Settings modal */
    #settingsModal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; }
    #settingsContent { background:var(--bg); padding:20px; border-radius:10px; min-width:300px; }
    #settingsContent h2 { margin-top:0; }
    #closeSettings { float:right; cursor:pointer; font-size:18px; }
    #settingsContent button { display:block; width:100%; margin:10px 0; padding:10px; border:none; border-radius:6px; cursor:pointer; }
  </style>
</head>
<body data-theme="light">
  <aside id="sidebar">
    <h3>Chats</h3>
    <div id="roomsContainer"></div>
    <button id="settingsBtn" class="room-btn">‚öôÔ∏è Settings</button>
  </aside>

  <div id="main">
    <header>
      <div id="roomTitle">Chat</div>
    </header>
    <section id="chat"></section>
    <footer>
      <input id="msgInput" placeholder="Type a message‚Ä¶" />
      <button id="sendBtn">Send</button>
    </footer>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal">
    <div id="settingsContent">
      <span id="closeSettings">‚ùå</span>
      <h2>Settings</h2>
      <button id="themeToggle">Toggle Theme</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>
</body>
</html>
