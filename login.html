<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Hybrid Chat â€” Login</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:Inter,Arial,sans-serif;background:#f5f7fa;margin:0;display:flex;align-items:center;justify-content:center;height:100vh}
  .card{width:340px;background:#fff;padding:22px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.08)}
  input,button{width:100%;padding:10px;margin-top:10px;border-radius:8px;border:1px solid #ddd;box-sizing:border-box}
  button{background:#3498db;color:#fff;border:0;font-weight:700;cursor:pointer}
  .link{margin-top:10px;text-align:center;color:#3498db;cursor:pointer}
  #msg{color:#c0392b;margin-top:8px;font-size:13px}
</style>
</head>
<body>
  <div class="card">
    <h2 style="margin:0 0 8px">Log in</h2>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button id="loginBtn">Log in</button>
    <div id="msg"></div>
    <div class="link" id="toSignup">Create an account</div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

// same firebaseConfig as above
const firebaseConfig = {
  apiKey: "AIzaSyA0m8RzkSmIgdPxvyMqW6SKsNLa_EvZJ9w",
  authDomain: "hybridchat-8a96c.firebaseapp.com",
  projectId: "hybridchat-8a96c",
  storageBucket: "hybridchat-8a96c.firebasestorage.app",
  messagingSenderId: "8350065462",
  appId: "1:8350065462:web:779c8fd3c81acaeebc8997"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const emailEl = document.getElementById('email');
const passEl = document.getElementById('password');
const btn = document.getElementById('loginBtn');
const msg = document.getElementById('msg');
document.getElementById('toSignup').onclick = ()=> location.href = 'signup.html';

btn.onclick = async () => {
  msg.textContent = '';
  const email = (emailEl.value||'').trim();
  const password = passEl.value || '';
  if(!email || !password){ msg.textContent = 'Email and password required'; return; }

  try{
    const cred = await signInWithEmailAndPassword(auth, email, password);
    const user = cred.user;

    // Attempt to load username from users/{uid}
    try{
      const userDoc = await getDoc(doc(db,'users', user.uid));
      if(userDoc.exists()){
        const data = userDoc.data();
        const username = data.username || user.email.split('@')[0];
        // ensure auth.displayName is set for backwards compatibility
        if(!user.displayName || user.displayName !== username){
          try{ await updateProfile(user, { displayName: username }); } catch(e){ /* noncritical */ }
        }
        sessionStorage.setItem('username', username);
      } else {
        // If there's no users/ doc, fallback to auth.displayName or email prefix
        const username = user.displayName || user.email.split('@')[0];
        sessionStorage.setItem('username', username);
      }
    }catch(e){
      console.warn('Could not load user doc', e);
      // fallback
      sessionStorage.setItem('username', user.displayName || user.email.split('@')[0]);
    }

    // redirect to chat
    window.location.href = 'chat.html';
  } catch(err){
    console.error(err);
    msg.textContent = err.message || 'Login failed';
  }
};
</script>
</body>
</html>
