<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WebRTC Chat — No Backend (Improved)</title>
  <style>
    :root { --blue:#4a90e2; --blue-dark:#357abd; --bg:#f7f9fc; }
    body{font-family:Inter,Arial,sans-serif;background:var(--bg);margin:0;padding:20px;}
    .container{max-width:820px;margin:12px auto;padding:18px;background:#fff;border-radius:12px;box-shadow:0 6px 20px rgba(15,25,40,0.06);}
    h1{margin:0 0 8px;font-size:20px;color:#222;text-align:center;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;}
    .full{grid-column:1/-1;}
    label{display:block;font-weight:600;margin-bottom:6px;color:#333;font-size:13px;}
    textarea{width:100%;min-height:110px;padding:10px;border-radius:8px;border:1px solid #e3e8ee;font-family:Menlo,monospace;font-size:13px;background:#fbfdff;resize:vertical;}
    .small-row{display:flex;gap:8px;align-items:center}
    button{background:var(--blue);color:#fff;border:0;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer;}
    button.secondary{background:#e9eef8;color:#2b4f7d;}
    button[disabled]{opacity:.55;cursor:not-allowed;}
    #chat{height:220px;overflow:auto;padding:10px;border-radius:8px;border:1px solid #e7eef8;background:#fbfdff;font-size:14px;}
    #controls{display:flex;gap:8px;margin-top:10px;}
    input[type="text"]{flex:1;padding:8px;border-radius:8px;border:1px solid #e3e8ee;}
    #log{height:120px;overflow:auto;padding:8px;border-radius:8px;border:1px dashed #d3dbe7;background:#fff;font-size:12px;color:#333;}
    .tip{font-size:12px;color:#5b6b80;margin-top:8px;}
    .copy-btn{background:#2f8c6a;}
    .reset{background:#c94b4b;}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <h1>WebRTC Peer-to-Peer Chat — No Backend</h1>

    <div class="grid">
      <div>
        <label>Offer (Create → Copy → Send to other user)</label>
        <div class="small-row">
          <button id="createOffer">Create Offer</button>
          <button id="copyOffer" class="copy-btn secondary">Copy Offer</button>
        </div>
        <textarea id="offer" placeholder="Offer will appear here..."></textarea>
      </div>

      <div>
        <label>Answer (Visible after Set Offer → Copy → Send back)</label>
        <div class="small-row">
          <button id="createAnswer">Create Answer</button>
          <button id="copyAnswer" class="copy-btn secondary">Copy Answer</button>
        </div>
        <textarea id="answer" placeholder="Answer will appear here..."></textarea>
      </div>

      <div class="full">
        <label>Remote boxes (paste here and press the matching button)</label>
        <div style="display:flex;gap:8px;">
          <button id="setOffer">Set Remote Offer (paste Offer above first)</button>
          <button id="setAnswer">Set Remote Answer (paste Answer above)</button>
          <button id="reset" class="reset">Reset Connection</button>
        </div>
        <div class="tip">Steps: Create Offer → Send → Paste & Set Offer → Create Answer → Send Answer → Paste & Set Answer.</div>
      </div>
    </div>

    <h3 style="margin:6px 0 8px;">Chat</h3>
    <div id="chat"></div>

    <div id="controls" style="margin-top:8px;">
      <input id="msg" type="text" placeholder="Type a message (enabled when connected)" />
      <button id="sendBtn" disabled>Send</button>
    </div>

    <h4 style="margin-top:14px;">Debug / Logs</h4>
    <div id="log"></div>
  </div>

  <script>
  // ======= Config & state =======
  const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] }; // STUN helps NAT traversal
  let pc = null;
  let dataChannel = null;
  const chatEl = document.getElementById('chat');
  const logEl = document.getElementById('log');
  const offerBox = document.getElementById('offer');
  const answerBox = document.getElementById('answer');
  const sendBtn = document.getElementById('sendBtn');
  const msgInput = document.getElementById('msg');

  // safe HTML escape
  function esc(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  function log(...args){
    const line = args.map(a=> typeof a === 'string' ? a : JSON.stringify(a)).join(' ');
    const now = new Date().toLocaleTimeString();
    logEl.innerHTML += `<div>[${now}] ${esc(line)}</div>`;
    logEl.scrollTop = logEl.scrollHeight;
    console.debug(...args);
  }

  function showChat(message, who = 'Peer'){
    chatEl.innerHTML += `<div><b>${who}:</b> ${esc(message)}</div>`;
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  // ======= Setup / reset =======
  function resetConnection(){
    if(pc){
      try{ pc.close(); } catch(e){}
      pc = null;
    }
    dataChannel = null;
    sendBtn.disabled = true;
    msgInput.value = '';
    logEl.innerHTML = '';
    chatEl.innerHTML = '';
    offerBox.value = '';
    answerBox.value = '';
    log('Connection reset. Create a new Offer or Set Offer from other user.');
  }

  function createPeerConnection(){
    if(pc){
      log('PeerConnection already exists — resetting first.');
      try{ pc.close(); } catch(e){}
    }
    pc = new RTCPeerConnection(config);

    pc.onicecandidate = (evt) => {
      if(evt.candidate){
        log('ICE candidate gathered (trickle).');
      } else {
        log('ICE gathering finished (null candidate).');
      }
    };

    pc.onicegatheringstatechange = () => log('ICE gathering state:', pc.iceGatheringState);
    pc.onconnectionstatechange = () => log('Connection state:', pc.connectionState);
    pc.oniceconnectionstatechange = () => log('ICE connection state:', pc.iceConnectionState);

    // If the remote peer created the DataChannel, it will arrive here
    pc.ondatachannel = (evt) => {
      log('Received data channel from remote peer.');
      dataChannel = evt.channel;
      setupDataChannelHandlers();
    };

    return pc;
  }

  function setupDataChannelHandlers(){
    if(!dataChannel) return;
    dataChannel.onopen = () => { log('DataChannel OPEN'); sendBtn.disabled = false; };
    dataChannel.onclose = () => { log('DataChannel CLOSED'); sendBtn.disabled = true; };
    dataChannel.onmessage = (e) => { showChat(e.data, 'Peer'); };
    dataChannel.onerror = (e) => log('DataChannel error', e);
  }

  async function waitForIceGatheringComplete(pcInstance){
    if(!pcInstance) return;
    if(pcInstance.iceGatheringState === 'complete') return;
    await new Promise((resolve) => {
      function check(){
        if(pcInstance.iceGatheringState === 'complete'){
          pcInstance.removeEventListener('icegatheringstatechange', check);
          resolve();
        }
      }
      pcInstance.addEventListener('icegatheringstatechange', check);
    });
  }

  // ======= Buttons =======
  document.getElementById('createOffer').onclick = async () => {
    resetConnection(); // start fresh
    createPeerConnection();
    // create local data channel (caller)
    dataChannel = pc.createDataChannel('chat');
    setupDataChannelHandlers();

    try {
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      log('Local description set. Waiting for ICE gathering to finish...');
      await waitForIceGatheringComplete(pc);
      // Now localDescription contains ICE candidates
      offerBox.value = JSON.stringify(pc.localDescription);
      log('Offer ready. Copy & send the entire Offer text to the other user.');
    } catch (err){
      log('Error creating offer:', err.toString());
    }
  };

  document.getElementById('setOffer').onclick = async () => {
    const text = offerBox.value.trim();
    if(!text){ log('Paste Offer into the Offer box first.'); return; }
    try{
      createPeerConnection(); // ensures ondatachannel is hooked
      const offer = JSON.parse(text);
      await pc.setRemoteDescription(offer);
      log('Remote Offer set.');
      // create answer next (user can click Create Answer to get the answer text)
    } catch(err){
      log('Failed to set remote offer. Make sure you pasted the full JSON exactly. Error:', err.toString());
    }
  };

  document.getElementById('createAnswer').onclick = async () => {
    if(!pc){ log('You must first paste and set the remote Offer (Set Remote Offer)'); return; }
    try{
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      log('Local answer set. Waiting for ICE gathering to finish...');
      await waitForIceGatheringComplete(pc);
      answerBox.value = JSON.stringify(pc.localDescription);
      log('Answer ready. Copy & send the Answer back to the Offer sender.');
    } catch(err){
      log('Error creating answer:', err.toString());
    }
  };

  document.getElementById('setAnswer').onclick = async () => {
    const text = answerBox.value.trim();
    if(!text){ log('Paste Answer into the Answer box first.'); return; }
    try{
      const answer = JSON.parse(text);
      await pc.setRemoteDescription(answer);
      log('Remote Answer set. If NAT traversal succeeded you should see "DataChannel OPEN" soon.');
    } catch(err){
      log('Failed to set remote answer. Error:', err.toString());
    }
  };

  // Copy helpers (use clipboard)
  document.getElementById('copyOffer').onclick = () => {
    const v = offerBox.value.trim();
    if(!v) { log('Nothing in Offer to copy.'); return; }
    navigator.clipboard?.writeText(v).then(()=>log('Offer copied to clipboard.')).catch(()=>log('Clipboard copy failed — select & copy manually.'));
  };
  document.getElementById('copyAnswer').onclick = () => {
    const v = answerBox.value.trim();
    if(!v) { log('Nothing in Answer to copy.'); return; }
    navigator.clipboard?.writeText(v).then(()=>log('Answer copied to clipboard.')).catch(()=>log('Clipboard copy failed — select & copy manually.'));
  };

  document.getElementById('reset').onclick = resetConnection;

  // Send message
  sendBtn.onclick = () => {
    const text = msgInput.value.trim();
    if(!text) return;
    if(!dataChannel || dataChannel.readyState !== 'open') { log('Channel not open yet.'); return; }
    try{
      dataChannel.send(text);
      showChat(text, 'You');
      msgInput.value = '';
    } catch(err){ log('Send failed:', err.toString()); }
  };

  // initialize trimmed UI
  resetConnection();

  // ======= Helpful tips visible in the console/log area =======
  log('Page ready. IMPORTANT: host this page on HTTPS (GitHub Pages) or open on http://localhost. Do not use file://');
  log('If connection fails: check log for ICE/connection states. "iceConnectionState: failed" likely needs a TURN server or different network.');
  </script>
</body>
</html>
