<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Hybrid Chat — Sign Up</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:Inter,Arial,sans-serif;background:#f5f7fa;margin:0;display:flex;align-items:center;justify-content:center;height:100vh}
  .card{width:360px;background:#fff;padding:22px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.08)}
  input,button{width:100%;padding:10px;margin-top:10px;border-radius:8px;border:1px solid #ddd;box-sizing:border-box}
  button{background:#3498db;color:#fff;border:0;font-weight:700;cursor:pointer}
  .link{margin-top:10px;text-align:center;color:#3498db;cursor:pointer}
  #msg{color:#c0392b;margin-top:8px;font-size:13px}
</style>
</head>
<body>
  <div class="card">
    <h2 style="margin:0 0 8px">Create account</h2>
    <input id="username" placeholder="Username (unique)" />
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password (6+ chars)" />
    <button id="signupBtn">Sign up</button>
    <div id="msg"></div>
    <div class="link" id="toLogin">Already have an account? Log in</div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import {
  getFirestore, collection, query, where, getDocs, doc, setDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

// ← YOUR FIREBASE CONFIG (unchanged from the project you gave earlier)
const firebaseConfig = {
  apiKey: "AIzaSyA0m8RzkSmIgdPxvyMqW6SKsNLa_EvZJ9w",
  authDomain: "hybridchat-8a96c.firebaseapp.com",
  projectId: "hybridchat-8a96c",
  storageBucket: "hybridchat-8a96c.firebasestorage.app",
  messagingSenderId: "8350065462",
  appId: "1:8350065462:web:779c8fd3c81acaeebc8997"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const usernameEl = document.getElementById('username');
const emailEl = document.getElementById('email');
const passEl = document.getElementById('password');
const btn = document.getElementById('signupBtn');
const msg = document.getElementById('msg');
document.getElementById('toLogin').onclick = ()=> location.href = 'login.html';

btn.onclick = async () => {
  msg.textContent = '';
  const username = (usernameEl.value||'').trim();
  const email = (emailEl.value||'').trim();
  const password = passEl.value || '';

  if(!username){ msg.textContent = 'Enter a username'; return; }
  if(!email){ msg.textContent = 'Enter an email'; return; }
  if(password.length < 6){ msg.textContent = 'Password must be at least 6 characters'; return; }

  try{
    // enforce unique username by checking users collection
    const q = query(collection(db,'users'), where('username','==', username));
    const snap = await getDocs(q);
    if(!snap.empty){ msg.textContent = 'Username already taken'; return; }

    // create auth user
    const cred = await createUserWithEmailAndPassword(auth, email, password);

    // set auth displayName (so auth.currentUser.displayName is available)
    try { await updateProfile(cred.user, { displayName: username }); } catch(e){ /* noncritical */ }

    // store canonical user doc under users/{uid}
    await setDoc(doc(db,'users', cred.user.uid), {
      username,
      email,
      createdAt: serverTimestamp()
    });

    // also save username locally (useful for some older code paths)
    sessionStorage.setItem('username', username);

    // go to chat
    window.location.href = 'chat.html';
  } catch(err){
    msg.textContent = err.message || 'Signup failed';
    console.error(err);
  }
};
</script>
</body>
</html>
